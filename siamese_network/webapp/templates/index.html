<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One-Shot Learning Playground</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --pastel-green: #a8e6cf;
        --pastel-green-dark: #8ed4b8;
        --pastel-blue: #b8e3ff;
        --pastel-blue-dark: #91c7e9;
        --accent-color: #ffaaa5;
        --text-color: #333333;
      }

      body {
        background-color: #f0f8f0;
        padding-top: 2rem;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-color);
      }

      .character-card {
        border: 3px solid transparent;
        border-radius: 12px;
        padding: 15px;
        margin: 8px;
        cursor: pointer;
        transition: all 0.3s;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .character-card img {
        width: 85px;
        height: 85px;
        image-rendering: auto;
        object-fit: contain;
      }

      .character-card:hover {
        transform: scale(1.08);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      .character-card.predicted {
        border-color: var(
          --pastel-green-dark
        ); /* Green for correct prediction */
        background-color: rgba(168, 230, 207, 0.2);
      }

      .character-card.incorrect {
        border-color: var(--accent-color); /* Red for incorrect prediction */
      }

      .character-card.true-match {
        background-color: rgba(168, 230, 207, 0.3); /* Light green background */
      }

      .character-card.user-selected {
        border-color: var(--pastel-blue-dark); /* Blue for user selection */
        border-width: 4px;
        box-shadow: 0 0 15px var(--pastel-blue);
      }
      .score-badge {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: rgba(145, 199, 233, 0.85);
        color: var(--text-color);
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      #support-card {
        margin-bottom: 25px;
        border: 3px solid var(--pastel-green);
        border-radius: 15px;
        padding: 20px;
        background-color: white;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.07);
        transition: all 0.3s;
      }

      #support-container {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border: 2px solid var(--pastel-blue);
      }

      #support-card {
        padding: 10px;
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        display: inline-block;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      #support-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        transform: translateY(-8px) scale(1.03);
      }

      #support-card img {
        width: 160px;
        height: 160px;
        object-fit: contain;
        image-rendering: auto;
        margin: 0 auto;
        display: block;
        border-radius: 10px;
      }

      #results-container {
        margin-top: 25px;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.5s ease;
      }

      #user-prompt {
        display: inline-block;
        padding: 8px 15px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        font-weight: 500;
        margin-left: 10px;
        transition: all 0.3s ease;
      }

      .challenge-info {
        background-color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border-left: 5px solid var(--pastel-blue);
      }

      .options-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
      }

      /* Adjust grid columns based on difficulty */
      .options-container.easy {
        grid-template-columns: repeat(2, 1fr);
      }

      .options-container.normal {
        grid-template-columns: repeat(3, 1fr);
      }

      .options-container.hard {
        grid-template-columns: repeat(4, 1fr);
      }

      .character-container {
        position: relative;
      }

      .loading {
        opacity: 0.5;
      }

      .spinner-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
      }

      #game-container {
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border-top: 5px solid var(--pastel-green);
        border-bottom: 5px solid var(--pastel-blue);
      }

      #loading-message {
        padding: 40px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }

      h1 {
        font-weight: 700;
        color: var(--pastel-green-dark);
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
      }

      h3 {
        font-weight: 600;
        color: var(--pastel-blue-dark);
      }
      .tab-pane {
        padding: 25px 0;
      }

      .nav-pills .nav-link {
        color: var(--text-color);
        font-weight: 500;
        border-radius: 10px;
        padding: 10px 20px;
        margin-right: 5px;
        transition: all 0.3s;
      }

      .nav-pills .nav-link.active {
        background-color: var(--pastel-blue);
        color: var(--text-color);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .nav-pills .nav-link:hover:not(.active) {
        background-color: rgba(184, 227, 255, 0.2);
      }

      .difficulty-btn {
        margin-right: 8px;
        border-radius: 30px;
        padding: 8px 16px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
      }

      .difficulty-btn:hover,
      .difficulty-btn:focus {
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
      }

      .difficulty-btn.btn-success {
        background-color: var(--pastel-green);
        color: var(--text-color);
      }

      .difficulty-btn.btn-primary {
        background-color: var(--pastel-blue);
        color: var(--text-color);
      }

      .difficulty-btn.btn-danger {
        background-color: var(--accent-color);
        color: var(--text-color);
      }

      .challenge-counter {
        background-color: white;
        border-radius: 12px;
        padding: 10px 15px;
        margin-bottom: 15px;
        font-weight: 500;
        color: var(--text-color);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        border-left: 4px solid var(--pastel-blue);
      }

      .highlight-text {
        font-weight: 600;
        color: var(--pastel-blue-dark);
      }

      .stats-card {
        background-color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        border-top: 4px solid var(--pastel-green);
      }

      .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
      }

      .stats-header {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--text-color);
      }

      .badge-count {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
        color: var(--pastel-blue-dark);
      }

      .diff-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .diff-badge.easy {
        background-color: var(--pastel-green);
        color: var(--text-color);
      }

      .diff-badge.normal {
        background-color: var(--pastel-blue);
        color: var(--text-color);
      }

      .diff-badge.hard {
        background-color: var(--accent-color);
        color: var(--text-color);
      }
      .chart-container {
        height: 250px;
        margin-top: 25px;
        background-color: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }

      footer {
        margin-top: 60px;
        padding: 25px 0;
        background-color: var(--pastel-green);
        background-image: linear-gradient(
          to right,
          var(--pastel-green),
          var(--pastel-blue)
        );
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        text-align: center;
        color: var(--text-color);
        font-weight: 500;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.03);
      }

      /* New button style for New Challenge button */
      .btn-challenge {
        background-image: linear-gradient(
          to right,
          var(--pastel-green),
          var(--pastel-blue)
        );
        border: none;
        padding: 12px 25px;
        font-weight: 600;
        border-radius: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        font-size: 1.1rem;
        color: var(--text-color);
      }

      .btn-challenge:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        background-image: linear-gradient(
          to right,
          var(--pastel-green-dark),
          var(--pastel-blue-dark)
        );
      }

      /* Animate new challenges */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .new-challenge-animation {
        animation: fadeIn 0.5s ease-out;
      }

      .container {
        max-width: 1200px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="text-center mb-5">
        <div class="animate-fadeInUp">
          <h1 class="display-4">One-Shot Learning Interactive Playground</h1>
          <p class="lead mb-0" style="font-size: 1.3rem; color: #555">
            Can our Siamese Neural Network find the matching character with just
            <span style="color: var(--pastel-blue-dark); font-weight: 600"
              >one example</span
            >?
          </p>
          <div class="mt-3 mb-3">
            <span
              class="badge rounded-pill"
              style="
                background-color: var(--pastel-green);
                color: var(--text-color);
                padding: 8px 15px;
                font-size: 0.9rem;
              "
            >
              <i class="bi bi-lightning-charge-fill me-1"></i> Siamese Network
            </span>
            <span
              class="badge rounded-pill"
              style="
                background-color: var(--pastel-blue);
                color: var(--text-color);
                padding: 8px 15px;
                font-size: 0.9rem;
                margin-left: 5px;
              "
            >
              <i class="bi bi-eye-fill me-1"></i> One-Shot Learning
            </span>
          </div>
        </div>
      </header>

      <div class="row">
        <div class="col-md-4">
          <!-- Navigation tabs -->
          <ul class="nav nav-pills mb-3" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="game-tab"
                data-bs-toggle="tab"
                data-bs-target="#game-content"
                type="button"
                role="tab"
                aria-controls="game-content"
                aria-selected="true"
              >
                <i class="bi bi-controller"></i> Game
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="stats-tab"
                data-bs-toggle="tab"
                data-bs-target="#stats-content"
                type="button"
                role="tab"
                aria-controls="stats-content"
                aria-selected="false"
              >
                <i class="bi bi-bar-chart"></i> Stats
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="about-tab"
                data-bs-toggle="tab"
                data-bs-target="#about-content"
                type="button"
                role="tab"
                aria-controls="about-content"
                aria-selected="false"
              >
                <i class="bi bi-info-circle"></i> About
              </button>
            </li>
          </ul>

          <!-- Tab content -->
          <div class="tab-content" id="main-tabs-content">
            <!-- Game tab -->
            <div
              class="tab-pane fade show active"
              id="game-content"
              role="tabpanel"
              aria-labelledby="game-tab"
            >
              <div class="challenge-info">
                <h3>How It Works</h3>
                <p>
                  This demo showcases the power of Siamese Networks for one-shot
                  learning:
                </p>
                <ol>
                  <li>
                    A random character is displayed at the top (support image)
                  </li>
                  <li>
                    The grid shows characters, including another example of the
                    same character
                  </li>
                  <li>The network compares the support image to each option</li>
                  <li>
                    The AI predicts which character is the match based on
                    learned visual similarity
                  </li>
                </ol>

                <div class="mb-3">
                  <h4>Difficulty Level</h4>
                  <div class="btn-group" role="group">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-success difficulty-btn"
                      data-difficulty="easy"
                    >
                      Easy (6 options)
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary difficulty-btn active"
                      data-difficulty="normal"
                    >
                      Normal (9 options)
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger difficulty-btn"
                      data-difficulty="hard"
                    >
                      Hard (12 options)
                    </button>
                  </div>
                </div>

                <div class="d-grid">
                  <button id="new-challenge-btn" class="btn btn-challenge">
                    <i class="bi bi-arrow-repeat me-2"></i> New Challenge
                  </button>
                </div>

                <div class="mt-4">
                  <h4>Game Stats</h4>
                  <div class="challenge-counter">
                    Challenge #<span id="challenge-number">0</span>
                  </div>
                  <p>
                    Model Accuracy: <span id="correct-count">0</span>/<span
                      id="total-count"
                      >0</span
                    >
                  </p>
                  <div class="progress">
                    <div
                      id="accuracy-bar"
                      class="progress-bar"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    >
                      0%
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats tab -->
            <div
              class="tab-pane fade"
              id="stats-content"
              role="tabpanel"
              aria-labelledby="stats-tab"
            >
              <div class="challenge-info">
                <h3>Model Performance</h3>

                <div class="stats-grid">
                  <div class="stats-card text-center">
                    <div class="stats-header">Total Challenges</div>
                    <span id="total-challenges" class="badge-count">0</span>
                  </div>
                  <div class="stats-card text-center">
                    <div class="stats-header">Model Accuracy</div>
                    <span id="overall-accuracy" class="badge-count">0%</span>
                  </div>
                  <div class="stats-card text-center">
                    <div class="stats-header">Correct</div>
                    <span id="total-correct" class="badge-count">0</span>
                  </div>
                </div>

                <h4>Performance by Difficulty</h4>
                <div class="row mb-3">
                  <div class="col-md-4 text-center">
                    <span class="diff-badge easy">Easy</span>
                    <div id="easy-accuracy" class="mt-2">0%</div>
                    <div class="small" id="easy-stats">(0/0)</div>
                  </div>
                  <div class="col-md-4 text-center">
                    <span class="diff-badge normal">Normal</span>
                    <div id="normal-accuracy" class="mt-2">0%</div>
                    <div class="small" id="normal-stats">(0/0)</div>
                  </div>
                  <div class="col-md-4 text-center">
                    <span class="diff-badge hard">Hard</span>
                    <div id="hard-accuracy" class="mt-2">0%</div>
                    <div class="small" id="hard-stats">(0/0)</div>
                  </div>
                </div>

                <h4>Recent Performance Trend</h4>
                <div class="chart-container">
                  <canvas id="performance-chart"></canvas>
                </div>
              </div>
            </div>

            <!-- About tab -->
            <div
              class="tab-pane fade"
              id="about-content"
              role="tabpanel"
              aria-labelledby="about-tab"
            >
              <div class="challenge-info">
                <h3>About Siamese Networks</h3>
                <p>
                  Siamese Neural Networks are a class of neural network
                  architectures that contain two or more identical subnetworks.
                  These networks are used to find the similarity between inputs
                  by comparing their feature representations.
                </p>

                <h4>One-Shot Learning</h4>
                <p>
                  One-shot learning is a machine learning approach where the
                  model learns to recognize objects from just one or a few
                  examples, unlike traditional deep learning which requires
                  large datasets.
                </p>

                <h4>How This Demo Works</h4>
                <p>
                  The Siamese Network in this demo was trained on the Omniglot
                  dataset, which contains handwritten characters from various
                  alphabets. The network learns to compare character images and
                  determine if they represent the same character, even when
                  they're written differently.
                </p>

                <h4>Technology Used</h4>
                <ul>
                  <li><strong>Backend:</strong> Python, Flask, TensorFlow</li>
                  <li>
                    <strong>Frontend:</strong> HTML, CSS, JavaScript, Bootstrap
                  </li>
                  <li>
                    <strong>Model:</strong> Siamese Neural Network with shared
                    weights
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div id="main-container">
            <div class="text-center" id="loading-message">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p>Loading challenge...</p>
            </div>

            <div id="game-container" style="display: none">
              <div id="support-container" class="text-center mb-4">
                <h3>Find a match for this character:</h3>
                <div id="support-card">
                  <img
                    id="support-image"
                    class="img-fluid"
                    alt="Support character"
                  />
                </div>
              </div>

              <h3>
                Options:
                <small class="text-muted" id="user-prompt"
                  >Click on the character you think is a match</small
                >
              </h3>
              <div class="options-container normal" id="options-container">
                <!-- Options will be dynamically added here -->
              </div>

              <div
                id="results-container"
                class="mt-4 alert alert-info"
                style="display: none"
              >
                <h4 id="result-heading"></h4>
                <p id="result-message"></p>
                <div id="user-vs-ai" class="mt-3" style="display: none">
                  <h5>Result Comparison:</h5>
                  <div class="row">
                    <div class="col-6">
                      <div class="card">
                        <div class="card-header bg-primary text-white">
                          Your Guess
                        </div>
                        <div
                          class="card-body text-center"
                          id="user-guess-result"
                        ></div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="card">
                        <div class="card-header bg-dark text-white">
                          AI's Prediction
                        </div>
                        <div
                          class="card-body text-center"
                          id="ai-guess-result"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button id="next-challenge-btn" class="btn btn-primary">
                    <i class="bi bi-arrow-right-circle"></i> Next Challenge
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>One-Shot Learning Interactive Playground</p>
        <p class="small">© 2023 - Siamese Neural Network Project</p>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Global variables
      let correctCount = 0;
      let totalCount = 0;
      let currentChallenge = null;
      let currentDifficulty = "normal";
      let userSelectedIndex = null;
      let performanceChart = null;

      // Function to update stats
      function updateStats() {
        document.getElementById("correct-count").textContent = correctCount;
        document.getElementById("total-count").textContent = totalCount;

        const accuracy =
          totalCount > 0 ? ((correctCount / totalCount) * 100).toFixed(1) : 0;
        const accuracyBar = document.getElementById("accuracy-bar");
        accuracyBar.style.width = `${accuracy}%`;
        accuracyBar.textContent = `${accuracy}%`;

        // Change color based on accuracy
        if (accuracy >= 80) {
          accuracyBar.classList.remove("bg-warning", "bg-danger");
          accuracyBar.classList.add("bg-success");
        } else if (accuracy >= 50) {
          accuracyBar.classList.remove("bg-success", "bg-danger");
          accuracyBar.classList.add("bg-warning");
        } else {
          accuracyBar.classList.remove("bg-success", "bg-warning");
          accuracyBar.classList.add("bg-danger");
        }
      }

      // Function to load a new challenge with improved visuals
      function loadNewChallenge() {
        // Reset user selection
        userSelectedIndex = null;

        // Show loading
        document.getElementById("loading-message").style.display = "block";
        document.getElementById("game-container").style.display = "none";

        // Hide previous results
        document.getElementById("results-container").style.display = "none";

        // Clear previous options
        document.getElementById("options-container").innerHTML = "";

        // Fetch new challenge from the API with current difficulty
        fetch(`/api/new-challenge?difficulty=${currentDifficulty}`)
          .then((response) => response.json())
          .then((data) => {
            // Store the current challenge data
            currentChallenge = data;

            // Update challenge number
            document.getElementById("challenge-number").textContent =
              data.challenge_id;

            // Set the support image with enhanced style
            const supportImage = document.getElementById("support-image");
            supportImage.src = `data:image/png;base64,${data.support_image}`;
            supportImage.style.imageRendering = "auto";

            // Add animation to the support card
            const supportCard = document.getElementById("support-card");
            supportCard.classList.add("new-challenge-animation");
            setTimeout(() => {
              supportCard.classList.remove("new-challenge-animation");
            }, 500);

            // Update options container class based on difficulty
            const optionsContainer =
              document.getElementById("options-container");
            optionsContainer.className = `options-container ${data.difficulty} new-challenge-animation`;

            // Generate option cards with improved visuals
            data.options.forEach((optionImage, index) => {
              // Reset any previous state if this is the first option
              if (index === 0) {
                optionsContainer.classList.remove("show-scores");
              }

              const optionDiv = document.createElement("div");
              optionDiv.className = "character-container animate-fadeInUp";

              const card = document.createElement("div");
              card.className = "character-card";
              card.dataset.index = index;
              card.onclick = () => selectOption(index);

              // Create image with improved rendering settings
              const img = document.createElement("img");
              img.src = `data:image/png;base64,${optionImage}`;
              img.alt = `Option ${index + 1}`;
              img.style.imageRendering = "auto";

              // Add a tiny animation delay for each card for a cascade effect
              card.style.animationDelay = `${index * 0.08}s`;

              // Add a card number for easier reference
              const cardNumber = document.createElement("div");
              cardNumber.className = "card-number";
              cardNumber.textContent = index + 1;
              card.appendChild(cardNumber);

              // Format score with consistent decimal places (initially hidden)
              const scoreValue = data.scores[index];
              const score = document.createElement("span");
              score.className = "score-badge";
              score.textContent = scoreValue.toFixed(2);

              // Highlight high scores with different colors
              if (scoreValue > 0.8) {
                score.style.backgroundColor = "rgba(140, 212, 175, 0.95)"; // Green for very high scores
                score.style.fontWeight = "bold";
              } else if (scoreValue > 0.6) {
                score.style.backgroundColor = "rgba(184, 227, 255, 0.95)"; // Blue for medium-high scores
                score.style.fontWeight = "bold";
              } else if (scoreValue < 0.3) {
                score.style.backgroundColor = "rgba(255, 200, 200, 0.9)"; // Red for low scores
              }

              card.appendChild(img);
              optionDiv.appendChild(card);
              optionDiv.appendChild(score);
              optionsContainer.appendChild(optionDiv);
            });

            // Hide loading, show game with a smooth transition
            document.getElementById("loading-message").style.display = "none";
            document.getElementById("game-container").style.display = "block";
          })
          .catch((error) => {
            console.error("Error loading challenge:", error);
            alert("Failed to load challenge. Please try again.");
            document.getElementById("loading-message").style.display = "none";
            document.getElementById("game-container").style.display = "block";
          });
      }

      // Function to select an option (user's guess)
      function selectOption(index) {
        // If results are already shown, don't allow selection
        if (
          document.getElementById("results-container").style.display !== "none"
        ) {
          return;
        }

        // Add a pulsing effect to the user prompt
        const userPrompt = document.getElementById("user-prompt");
        userPrompt.textContent = "Processing your selection...";
        userPrompt.classList.add("pulse");

        // Remove previous selection
        document.querySelectorAll(".character-card").forEach((card) => {
          card.classList.remove("user-selected");
        });

        // Mark the selected card
        const selectedCard = document.querySelector(
          `.character-card[data-index="${index}"]`
        );
        selectedCard.classList.add("user-selected");

        // Store the selection
        userSelectedIndex = index;

        // Show the scores after selection with a nice transition
        const optionsContainer = document.getElementById("options-container");
        setTimeout(() => {
          optionsContainer.classList.add("show-scores");
        }, 300);

        // Add a slight bounce animation to the selected card
        selectedCard.classList.add("tada");

        // Show results after a short delay to let animations complete
        setTimeout(() => {
          // Remove the pulsing effect
          userPrompt.classList.remove("pulse");
          userPrompt.textContent = "Here are the results:";

          showResults();
        }, 800);
      }

      // Function to show results after user selection
      function showResults() {
        // If no selection or no challenge, exit
        if (userSelectedIndex === null || !currentChallenge) {
          return;
        }

        const trueIndex = currentChallenge.true_match_index;
        const predictedIndex = currentChallenge.predicted_match_index;

        const resultsContainer = document.getElementById("results-container");
        const resultHeading = document.getElementById("result-heading");
        const resultMessage = document.getElementById("result-message");

        // Show all cards' status with enhanced visuals
        const cards = document.querySelectorAll(".character-card");
        cards.forEach((card, index) => {
          // Apply visual indicators to cards
          card.classList.remove("highlight-correct", "shake");

          // Add special effects to the true match
          if (index === trueIndex) {
            card.classList.add("true-match", "highlight-correct");
            setTimeout(() => {
              // Add a bouncy effect to the true match
              card.classList.add("tada");
            }, 200);
          }

          // Add shake animation if user selected wrong card
          if (userSelectedIndex !== trueIndex && userSelectedIndex === index) {
            setTimeout(() => {
              card.classList.add("shake");
            }, 200);
          }

          if (index === predictedIndex) {
            card.classList.add(
              predictedIndex === trueIndex ? "predicted" : "incorrect"
            );
          }
        });

        // Update user vs AI comparison with animations
        document.getElementById("user-vs-ai").style.display = "block";
        document.getElementById("user-vs-ai").classList.add("animate-fadeInUp");

        // User's guess result with enhanced animations
        const userCorrect = userSelectedIndex === trueIndex;
        const userGuessResult = document.getElementById("user-guess-result");
        userGuessResult.innerHTML = userCorrect
          ? '<i class="bi bi-check-circle-fill text-success fs-1 animate-fadeInUp"></i><p class="mb-0 mt-2">Correct!</p>'
          : '<i class="bi bi-x-circle-fill text-danger fs-1 animate-fadeInUp"></i><p class="mb-0 mt-2">Incorrect</p>';

        // AI's prediction result with enhanced animations
        const aiCorrect = predictedIndex === trueIndex;
        const aiGuessResult = document.getElementById("ai-guess-result");
        aiGuessResult.innerHTML = aiCorrect
          ? '<i class="bi bi-check-circle-fill text-success fs-1 animate-fadeInUp"></i><p class="mb-0 mt-2">Correct!</p>'
          : '<i class="bi bi-x-circle-fill text-danger fs-1 animate-fadeInUp"></i><p class="mb-0 mt-2">Incorrect</p>';

        // Update the result message based on AI's performance
        if (predictedIndex === trueIndex) {
          resultsContainer.className = "mt-4 alert alert-success";
          resultHeading.textContent = "✓ Model Predicted Correctly!";
          resultMessage.textContent =
            "The Siamese Network successfully identified the matching character.";
          correctCount++;
        } else {
          resultsContainer.className = "mt-4 alert alert-danger";
          resultHeading.textContent = "✗ Model Predicted Incorrectly";
          resultMessage.textContent =
            "The model failed to find the correct match. The true match is highlighted in green.";
        }

        totalCount++;
        updateStats();
        fetchGlobalStats();

        // Show the results
        resultsContainer.style.display = "block";
      }

      // Function to fetch global stats
      function fetchGlobalStats() {
        fetch("/api/stats")
          .then((response) => response.json())
          .then((data) => {
            // Update total stats
            document.getElementById("total-challenges").textContent =
              data.total_challenges;
            document.getElementById("overall-accuracy").textContent =
              data.accuracy.toFixed(1) + "%";
            document.getElementById("total-correct").textContent =
              data.correct_predictions;

            // Update stats by difficulty
            const difficulties = ["easy", "normal", "hard"];
            difficulties.forEach((diff) => {
              const stats = data.by_difficulty[diff];
              document.getElementById(`${diff}-accuracy`).textContent =
                stats.accuracy.toFixed(1) + "%";
              document.getElementById(
                `${diff}-stats`
              ).textContent = `(${stats.correct}/${stats.total})`;
            });

            // Update the performance chart
            updatePerformanceChart(data.recent_performance);
          })
          .catch((error) => {
            console.error("Error fetching stats:", error);
          });
      }

      // Function to initialize the performance chart
      function initPerformanceChart() {
        const ctx = document
          .getElementById("performance-chart")
          .getContext("2d");

        performanceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [], // Will be filled with challenge IDs
            datasets: [
              {
                label: "Model Performance",
                data: [], // Will be filled with 1 (correct) or 0 (incorrect)
                borderColor: "#0d6efd",
                backgroundColor: "rgba(13, 110, 253, 0.1)",
                borderWidth: 2,
                tension: 0.1,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 1,
                ticks: {
                  stepSize: 1,
                  callback: function (value) {
                    return value === 1
                      ? "Correct"
                      : value === 0
                      ? "Incorrect"
                      : "";
                  },
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const diffIndex = context.dataIndex;
                    const diff = context.chart.data.difficulties[diffIndex];
                    const result =
                      context.parsed.y === 1 ? "Correct" : "Incorrect";
                    return `${result} (${diff})`;
                  },
                },
              },
            },
          },
        });

        // Add a custom property to store difficulties
        performanceChart.data.difficulties = [];
      }

      // Function to update the performance chart
      function updatePerformanceChart(recentPerformance) {
        if (!performanceChart) {
          initPerformanceChart();
        }

        // Clear previous data
        performanceChart.data.labels = [];
        performanceChart.data.datasets[0].data = [];
        performanceChart.data.difficulties = [];

        // Add new data
        recentPerformance.forEach((challenge) => {
          performanceChart.data.labels.push(challenge.id);
          performanceChart.data.datasets[0].data.push(
            challenge.correct ? 1 : 0
          );
          performanceChart.data.difficulties.push(challenge.difficulty);
        });

        // Update the chart
        performanceChart.update();
      }

      // Set up difficulty buttons
      document.querySelectorAll(".difficulty-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          // Remove active class from all buttons
          document.querySelectorAll(".difficulty-btn").forEach((b) => {
            b.classList.remove("active");
          });

          // Add active class to clicked button
          btn.classList.add("active");

          // Set the current difficulty
          currentDifficulty = btn.dataset.difficulty;
        });
      });

      // Event listeners
      document
        .getElementById("new-challenge-btn")
        .addEventListener("click", loadNewChallenge);

      document
        .getElementById("next-challenge-btn")
        .addEventListener("click", loadNewChallenge);

      // Initialize stats tab when clicked
      document
        .getElementById("stats-tab")
        .addEventListener("click", fetchGlobalStats);

      // Load the first challenge when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        loadNewChallenge();
        fetchGlobalStats();
      });
    </script>
  </body>
</html>
